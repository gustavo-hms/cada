#!/usr/bin/python3

import time
import trio
from tabulate import tabulate

FILES = [
    "ipairs-imperative.lua",
    "ipairs-cada.lua"
]

ITERATIONS = 20

async def exec_file(name, channel):
    durations = []

    async with channel:
        for _ in range(1, ITERATIONS):
            start = time.perf_counter()
            info = await trio.run_process(["lua", "benchmarks/{}".format(name)], check = False)
            duration = time.perf_counter() - start
            durations.append(duration)
            
        await channel.send((info.returncode, name, durations))


async def main():
    stats = {}

    async with trio.open_nursery() as nursery:
        send, receive = trio.open_memory_channel(0)

        async with send:
            for name in FILES:
                nursery.start_soon(exec_file, name, send.clone())

        async with receive:
            async for message in receive:
                code, name, durations = message
                if code != 0:
                    print("O programa {} rodou com erro {}".format(name, code))
                    exit(code)

                mean = sum(durations)/ITERATIONS
                prefix = name.split("-", maxsplit=1)[0]
                group = stats.get(prefix, [])
                group.append( (mean, durations, name) )
                stats[prefix] = group

    fastest = { group : min(item) for group, item in stats.items() }
    table = [ line(item, fastest[group]) for group, items in stats.items() for item in items ]

    print(tabulate(table, headers = ["Programa", "Duração (s)", "Relação"], tablefmt="github"))

def error(mean, durations):
    deviation = (sum([(dur - mean)**2 for dur in durations])/ITERATIONS)**0.5
    return deviation/(ITERATIONS**0.5)

def line(file_info, fastest):
    mean, durations, name = file_info
    _, fdurations, _ = fastest

    ratios = [ dur/fdur for dur, fdur in zip(durations, fdurations) ]
    ratios_mean = sum(ratios)/ITERATIONS
    
    pattern = "{:.4f} ± {:.4f}"
    return [
        name,
        pattern.format(mean, error(mean, durations)),
        pattern.format(ratios_mean, error(ratios_mean, fdurations))
    ]


trio.run(main)
